# 手动输入食材显示问题修复

## 问题

手动输入的食材已保存到数据库，但在菜谱页面没有展示。

## 原因

保存菜谱后没有刷新数据，导致前端显示的是旧数据。

## 解决方案

### 修改 1：优化数据转换逻辑 (lib/adapters.ts)

改进了 `toRecipe` 函数中的食材数据转换逻辑，使其更清晰：

```typescript
ingredients: dbIngredients.map((ing: any) => {
  // 优先使用手动输入的名称，然后是关联食材的名称
  const name = ing.name || ing.kc_ingredients?.name || '';
  const unit = ing.unit || ing.kc_ingredients?.unit || '';
  const isManual = !ing.ingredient_id;
  
  return {
    ingredientId: ing.ingredient_id || '',
    amount: ing.quantity,
    name,
    unit,
    isManual,
  };
}),
```

### 修改 2：保存后刷新数据 (pages/Recipes.tsx)

修改 `handleSaveRecipe` 函数，使其在保存后刷新数据：

```typescript
const handleSaveRecipe = async () => {
  if (!editingRecipe?.name) return alert('请输入菜谱名称');
  
  const finalRecipe = {
    ...editingRecipe,
    ingredients: editingRecipe.ingredients || [],
    steps: editingRecipe.steps || [],
    tags: editingRecipe.tags || [],
  } as Recipe;

  try {
    if (editingRecipe.id) {
      await updateRecipe(finalRecipe);
    } else {
      await addRecipe(finalRecipe);
    }
    // 刷新数据以确保显示最新的食材信息
    await refresh();
    setView('list');
    setEditingRecipe(null);
  } catch (error) {
    console.error('保存菜谱失败:', error);
    alert('保存失败，请重试');
  }
};
```

## 关键改进

1. **异步处理**：将 `handleSaveRecipe` 改为 `async` 函数
2. **等待保存完成**：使用 `await` 等待 `addRecipe` 或 `updateRecipe` 完成
3. **刷新数据**：保存成功后调用 `await refresh()` 刷新所有数据
4. **错误处理**：添加 try-catch 块处理保存失败的情况

## 测试步骤

1. 创建或编辑菜谱
2. 点击"手动输入"添加食材
3. 输入食材名称、数量、单位
4. 保存菜谱
5. 在菜谱列表中点击查看该菜谱
6. 确认手动输入的食材正确显示

## 预期结果

- 手动输入的食材应该立即显示在菜谱预览页面
- 食材名称、数量、单位都应该正确显示
- 编辑菜谱时，手动输入的食材应该显示为手动输入模式（三个输入框）

## 如果仍然不显示

请参考 `DEBUG_RECIPE_INGREDIENTS.md` 进行详细调试。
