# 菜谱食材手动输入 - 快速开始

## 问题

保存菜谱时，手动输入的食材没有被保存。

## 原因

数据库表 `kc_recipe_ingredients` 缺少 `name` 字段来存储手动输入的食材名称。

## 解决方案

### 第一步：执行数据库迁移 ⚠️ 必须先执行

#### 方法 1：一次性执行（推荐）

1. 登录 Supabase Dashboard
2. 打开 SQL Editor
3. 执行 `supabase/migration_add_name_to_recipe_ingredients.sql` 文件中的 SQL

#### 方法 2：分步执行（如果方法 1 失败）

如果一次性执行失败，使用 `supabase/migration_add_name_to_recipe_ingredients_step_by_step.sql`，按照注释逐步执行。

详细步骤：`supabase/EXECUTE_RECIPE_INGREDIENT_NAME_MIGRATION.md`

### 第二步：验证迁移

在 SQL Editor 中执行：

```sql
-- 查看表结构
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'kc_recipe_ingredients';

-- 确认 name 字段已添加
-- 检查是否有问题数据
SELECT * FROM kc_recipe_ingredients 
WHERE ingredient_id IS NULL AND (name IS NULL OR name = '');
```

如果查询结果为空，说明迁移成功！

### 第三步：测试功能

1. 打开菜谱编辑页面
2. 点击"手动输入"按钮
3. 输入食材名称、数量、单位
4. 保存菜谱
5. 刷新页面，确认食材已保存

## 故障排除

### 错误：check constraint "chk_ingredient_id_or_name" is violated

**原因**：数据库中存在 ingredient_id 和 name 都为空的行

**解决方案**：

```sql
-- 1. 查看问题数据
SELECT * FROM kc_recipe_ingredients 
WHERE ingredient_id IS NULL;

-- 2. 修复数据
UPDATE kc_recipe_ingredients 
SET name = '未知食材'
WHERE ingredient_id IS NULL AND (name IS NULL OR name = '');

-- 3. 重新执行迁移脚本
```

### 如果迁移完全失败

可以先回滚，然后重新执行：

```sql
-- 回滚
ALTER TABLE kc_recipe_ingredients DROP CONSTRAINT IF EXISTS chk_ingredient_id_or_name;
ALTER TABLE kc_recipe_ingredients DROP COLUMN IF EXISTS name;

-- 然后重新执行迁移脚本
```

## 修改的文件

- ✅ `types.ts` - 添加 `isManual` 字段
- ✅ `pages/Recipes.tsx` - 添加手动输入界面
- ✅ `lib/adapters.ts` - 更新数据转换逻辑
- ✅ `supabase/migration_add_name_to_recipe_ingredients.sql` - 数据库迁移脚本

## 功能说明

- **手动输入**：直接输入食材名称、数量、单位（不关联冰箱食材）
- **从冰箱选择**：从已有的冰箱食材中选择（关联冰箱食材）

## 重要提示

⚠️ **必须先执行数据库迁移，否则保存菜谱时会失败！**
