# 游客查看作者信息修复

## 问题
1. 游客浏览菜谱时，作者显示"未知用户"，无法点击查看作者主页
2. 游客访问菜谱大全时，没有展示任何菜谱数据

## 解决方案
1. 创建公开的用户配置表（profiles），让游客也能查询用户信息
2. 修复数据加载逻辑，让游客也能加载公共数据

## 执行步骤

### 1. 执行数据库迁移

在 Supabase SQL Editor 中执行：
```
supabase/migration_create_profiles_table.sql
```

这个迁移会：
- 创建 `kc_profiles` 表
- 设置 RLS 策略（所有人可读，仅本人可写）
- 创建触发器，在新用户注册时自动创建 profile
- 创建更新后的视图，包含作者信息
- 授予视图的访问权限给匿名用户和认证用户

### 2. 为现有用户创建 profiles

在 Supabase SQL Editor 中执行：
```sql
INSERT INTO kc_profiles (id, display_name, avatar_url, bio)
SELECT 
  id,
  COALESCE(raw_user_meta_data->>'display_name', SPLIT_PART(email, '@', 1)) as display_name,
  raw_user_meta_data->>'avatar_url' as avatar_url,
  raw_user_meta_data->>'bio' as bio
FROM auth.users
WHERE id NOT IN (SELECT id FROM kc_profiles);
```

### 3. 完成

代码已自动更新，执行完数据库迁移后即可生效。

## 代码修复

### 修复的问题
1. **视图权限**：添加了 `GRANT SELECT ON v_kc_recipe_details TO anon, authenticated;`
2. **数据加载逻辑**：修改了 store.tsx 中的数据加载条件
   - 之前：只有 `user` 存在时才加载数据
   - 现在：等待 `authLoading` 完成后就加载数据（无论是否有用户）
   - 这样游客（user 为 null）也能加载公共数据

## 效果

✅ 游客可以看到菜谱作者的正确名称  
✅ 点击作者名称可以跳转到作者主页  
✅ 游客可以浏览作者主页和 TA 创建的菜谱  
✅ 游客可以正常浏览菜谱大全  
✅ 性能优化：批量查询用户信息

## 测试

1. 退出登录，以游客身份浏览菜谱广场
2. 确认能看到菜谱列表
3. 查看菜谱卡片上的作者信息是否正确显示
4. 点击作者名称，查看是否能跳转到作者主页
5. 在作者主页查看 TA 创建的菜谱列表
