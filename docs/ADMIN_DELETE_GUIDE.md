# 管理员删除功能使用指南

## 概述

管理员页面现在支持单个删除和批量删除菜谱功能，并且能够绕过 RLS（Row Level Security）策略，删除任何用户创建的菜谱。

## 功能特性

### 1. 单个删除
- 点击菜谱行右侧的"删除"按钮
- 确认删除操作
- 系统会自动删除菜谱及其相关数据：
  - 菜谱食材关联（kc_recipe_ingredients）
  - 菜谱步骤（kc_recipe_steps）
  - 菜谱计划（kc_meal_plans）
  - 菜谱本身（kc_recipes）

### 2. 批量删除
- 使用表头的复选框选择所有菜谱
- 或者单独点击每行的复选框选择特定菜谱
- 点击"批量删除"按钮
- 确认批量删除操作
- 系统会一次性删除所有选中的菜谱及其相关数据

## 技术实现

### 数据库函数

在 Supabase 中创建了两个数据库函数来绕过 RLS 策略：

1. `admin_delete_recipe(recipe_id UUID)` - 删除单个菜谱
2. `admin_delete_recipes(recipe_ids UUID[])` - 批量删除菜谱

这些函数使用 `SECURITY DEFINER` 标记，可以绕过 RLS 策略执行删除操作。

### 服务方法

在 `recipes.service.ts` 中添加了三个删除方法：

1. `delete(id)` - 普通用户删除自己的菜谱（受 RLS 限制）
2. `adminDelete(id)` - 管理员删除单个菜谱（绕过 RLS）
3. `adminBatchDelete(ids)` - 管理员批量删除菜谱（绕过 RLS）

## 使用步骤

### 部署数据库函数

1. 登录 Supabase 控制台
2. 进入 SQL Editor
3. 执行 `supabase/migration_admin_delete_functions.sql` 文件中的 SQL 语句
4. 确认函数创建成功

### 使用管理员页面

1. 访问 `/admin` 路径
2. 输入管理员密码（默认：huha2026）
3. 查看所有菜谱列表
4. 选择要删除的菜谱：
   - 单个删除：点击右侧"删除"按钮
   - 批量删除：勾选复选框，点击"批量删除"按钮
5. 确认删除操作

## 注意事项

1. **权限控制**：当前所有认证用户都可以调用这些函数。在生产环境中，建议添加额外的权限检查。

2. **数据恢复**：删除操作是不可逆的，请谨慎操作。

3. **级联删除**：数据库已配置 `ON DELETE CASCADE`，但代码中仍然明确删除相关数据以确保完整性。

4. **错误处理**：如果删除失败，会显示详细的错误信息。

## 安全建议

在生产环境中，建议：

1. 修改数据库函数，添加管理员角色检查
2. 使用环境变量存储管理员密码
3. 添加操作日志记录
4. 实现软删除而非硬删除
5. 添加删除前的数据备份机制

## 故障排查

### 删除失败

如果删除操作失败，请检查：

1. 数据库函数是否已正确创建
2. 函数权限是否已正确授予
3. 网络连接是否正常
4. 浏览器控制台是否有错误信息

### RLS 策略问题

如果遇到 RLS 策略相关的错误：

1. 确认使用的是 `adminDelete` 或 `adminBatchDelete` 方法
2. 检查数据库函数是否使用了 `SECURITY DEFINER`
3. 验证函数权限设置

## 更新日志

- 2026-01-30：添加管理员删除和批量删除功能
- 2026-01-30：创建数据库函数绕过 RLS 策略
- 2026-01-30：优化删除流程，确保相关数据完整删除
