# 表名更新说明

## 更新内容

将用户配置表从 `public.profiles` 改为 `kc_profiles`，保持与其他表的命名一致性。

## 更新的文件

### 数据库迁移
- `supabase/migration_create_profiles_table.sql`
  - 表名：`public.profiles` → `kc_profiles`
  - 索引名：`idx_profiles_display_name` → `idx_kc_profiles_display_name`
  - 触发器名：`update_profiles_updated_at` → `update_kc_profiles_updated_at`
  - 视图中的 JOIN：`public.profiles` → `kc_profiles`

### 服务层
- `services/users.service.ts`
  - 所有查询从 `'profiles'` 改为 `'kc_profiles'`
  - `getUserById()`, `getUsersByIds()`, `updateProfile()`, `ensureProfile()`

- `services/auth.service.ts`
  - `updateProfile()` 方法中的表名更新

### 文档
- `docs/游客查看作者信息修复.md`
- `docs/PROFILES_TABLE_MIGRATION_GUIDE.md`
- `docs/游客模式测试指南.md`

## 执行步骤

### 如果还未执行迁移
直接执行更新后的迁移文件即可：
```sql
-- 在 Supabase SQL Editor 中执行
supabase/migration_create_profiles_table.sql
```

### 如果已经执行了旧的迁移
需要重命名表：

```sql
-- 1. 删除旧的触发器
DROP TRIGGER IF EXISTS update_profiles_updated_at ON public.profiles;

-- 2. 重命名表
ALTER TABLE public.profiles RENAME TO kc_profiles;

-- 3. 重命名索引
ALTER INDEX idx_profiles_display_name RENAME TO idx_kc_profiles_display_name;

-- 4. 更新 RLS 策略（策略名称会自动更新）

-- 5. 创建新的触发器
CREATE TRIGGER update_kc_profiles_updated_at 
  BEFORE UPDATE ON kc_profiles
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- 6. 更新视图
DROP VIEW IF EXISTS v_kc_recipe_details;

CREATE VIEW v_kc_recipe_details AS
SELECT
  r.id,
  r.name,
  r.category_id,
  c.name AS category_name,
  r.difficulty,
  r.description,
  r.notes,
  r.image,
  r.tags,
  r.prep_time,
  r.cook_time,
  r.servings,
  r.user_id,
  r.created_at,
  r.updated_at,
  p.display_name AS author_name,
  p.avatar_url AS author_avatar,
  COUNT(DISTINCT ri.id) AS ingredient_count,
  COUNT(DISTINCT rs.id) AS step_count
FROM kc_recipes r
LEFT JOIN kc_categories c ON r.category_id = c.id
LEFT JOIN kc_profiles p ON r.user_id = p.id
LEFT JOIN kc_recipe_ingredients ri ON r.id = ri.recipe_id
LEFT JOIN kc_recipe_steps rs ON r.id = rs.recipe_id
GROUP BY r.id, c.name, p.display_name, p.avatar_url;

-- 7. 授予视图权限
GRANT SELECT ON v_kc_recipe_details TO anon, authenticated;
```

## 验证

执行以下 SQL 验证更新是否成功：

```sql
-- 1. 检查表是否存在
SELECT * FROM kc_profiles LIMIT 5;

-- 2. 检查索引
SELECT indexname FROM pg_indexes WHERE tablename = 'kc_profiles';

-- 3. 检查 RLS 策略
SELECT * FROM pg_policies WHERE tablename = 'kc_profiles';

-- 4. 检查触发器
SELECT tgname FROM pg_trigger WHERE tgrelid = 'kc_profiles'::regclass;

-- 5. 检查视图
SELECT * FROM v_kc_recipe_details LIMIT 5;
```

## 注意事项

1. **命名一致性**：现在所有应用表都使用 `kc_` 前缀
   - `kc_categories`
   - `kc_ingredients`
   - `kc_recipes`
   - `kc_recipe_ingredients`
   - `kc_recipe_steps`
   - `kc_meal_plans`
   - `kc_profiles` ✅ 新增

2. **代码已同步更新**：所有引用 `profiles` 表的代码都已更新为 `kc_profiles`

3. **向后兼容**：如果已有数据在 `public.profiles` 表中，使用上面的重命名脚本迁移

4. **测试建议**：更新后建议执行完整的测试流程（见 `docs/游客模式测试指南.md`）
