# 游客模式测试指南

## 测试前准备

1. 确保已执行数据库迁移：`supabase/migration_create_profiles_table.sql`
2. 确保已为现有用户创建 profiles（见文档）
3. 确保数据库中有一些测试菜谱数据

## 测试步骤

### 1. 测试游客访问菜谱大全

**操作：**
1. 如果已登录，先退出登录
2. 访问菜谱大全页面

**预期结果：**
- ✅ 能看到菜谱列表（不是空白）
- ✅ 每个菜谱卡片显示正常
- ✅ 可以看到菜谱的封面图、名称、描述、标签等信息

**如果失败：**
- 检查浏览器控制台是否有错误
- 检查 Supabase 日志，看是否有权限错误
- 确认视图权限已正确设置：`GRANT SELECT ON v_kc_recipe_details TO anon, authenticated;`

### 2. 测试游客查看作者信息

**操作：**
1. 在菜谱大全中，查看有作者的菜谱卡片

**预期结果：**
- ✅ 菜谱卡片左下角显示作者头像和名称（不是"未知用户"）
- ✅ 作者信息显示正确的用户昵称

**如果失败：**
- 检查该菜谱的 `user_id` 是否存在
- 检查 kc_profiles 表中是否有该用户的记录
- 检查浏览器控制台是否有查询错误

### 3. 测试游客点击作者跳转

**操作：**
1. 在菜谱卡片上点击作者名称

**预期结果：**
- ✅ 页面跳转到作者主页（URL 类似 `/profile/用户ID`）
- ✅ 能看到作者的个人信息（昵称、签名、头像）
- ✅ 能看到作者创建的菜谱列表

**如果失败：**
- 检查路由是否正确配置
- 检查 Profile 页面是否允许游客访问
- 检查浏览器控制台错误

### 4. 测试游客查看菜谱详情

**操作：**
1. 点击任意菜谱卡片，进入菜谱详情页

**预期结果：**
- ✅ 能看到完整的菜谱信息
- ✅ 在基础信息区域能看到作者信息
- ✅ 点击作者名称能跳转到作者主页
- ✅ 不显示"编辑"和"删除"按钮（因为是游客）

### 5. 测试登录用户功能

**操作：**
1. 登录一个测试账号
2. 访问菜谱大全

**预期结果：**
- ✅ 能看到"我的菜谱"和"菜谱广场"两个标签
- ✅ "我的菜谱"只显示自己创建的菜谱
- ✅ "菜谱广场"显示所有菜谱
- ✅ 自己的菜谱显示"编辑"和"删除"按钮
- ✅ 其他人的菜谱不显示这些按钮

### 6. 测试用户信息更新

**操作：**
1. 登录后，访问个人主页
2. 点击"编辑资料"
3. 修改昵称、头像或签名
4. 保存

**预期结果：**
- ✅ 保存成功，显示成功提示
- ✅ 个人主页立即显示更新后的信息
- ✅ 返回菜谱大全，自己创建的菜谱上的作者信息也更新了
- ✅ 退出登录，以游客身份查看，作者信息也是最新的

## 常见问题排查

### 问题1：游客看不到菜谱列表

**可能原因：**
- 视图权限未正确设置
- RLS 策略配置错误
- 数据加载逻辑有问题

**排查步骤：**
1. 检查浏览器控制台错误
2. 在 Supabase SQL Editor 中测试查询：
   ```sql
   SELECT * FROM v_kc_recipe_details LIMIT 10;
   ```
3. 检查 store.tsx 中的 `authLoading` 和数据加载逻辑

### 问题2：作者显示"未知用户"

**可能原因：**
- kc_profiles 表中没有该用户的记录
- 用户查询失败

**排查步骤：**
1. 检查 kc_profiles 表：
   ```sql
   SELECT * FROM kc_profiles;
   ```
2. 为缺失的用户创建 profile：
   ```sql
   INSERT INTO kc_profiles (id, display_name)
   SELECT id, SPLIT_PART(email, '@', 1)
   FROM auth.users
   WHERE id NOT IN (SELECT id FROM kc_profiles);
   ```

### 问题3：点击作者无法跳转

**可能原因：**
- 路由配置问题
- Profile 页面权限限制

**排查步骤：**
1. 检查 App.tsx 中的路由配置
2. 检查 Profile.tsx 中的游客访问逻辑
3. 查看浏览器控制台错误

## 性能检查

### 批量查询优化

**检查方法：**
1. 打开浏览器开发者工具的 Network 标签
2. 访问菜谱大全页面
3. 查看对 Supabase 的请求

**预期结果：**
- ✅ 只有一次查询 profiles 表的请求（使用 `in` 查询）
- ✅ 不应该有多次单独的用户查询

**如果有多次查询：**
- 检查 usersService.getUsersByIds 的实现
- 确认使用了批量查询而不是循环查询

## 测试完成清单

- [ ] 游客能看到菜谱列表
- [ ] 游客能看到正确的作者名称
- [ ] 游客能点击作者跳转到主页
- [ ] 游客能查看作者的菜谱列表
- [ ] 登录用户能编辑自己的资料
- [ ] 资料更新后，菜谱上的作者信息同步更新
- [ ] 新注册用户自动创建 profile
- [ ] 性能良好，没有多余的查询
